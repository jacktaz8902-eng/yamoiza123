<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>야모이자 야외방탈출 체크인 시스템</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      line-height: 1.6;
      background: #f5f5f7;
    }
    h1 {
      margin-bottom: 4px;
      font-size: 1.4rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 16px;
      margin-bottom: 8px;
    }
    #meta {
      display: none; /* 행사 ID / 팀 ID 안내는 블라인드 처리 (내부용) */
    }
    #info {
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: #333;
      white-space: pre-line;
    }
    #userSection {
      margin: 10px 0 18px;
      padding: 10px 12px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      font-size: 0.9rem;
    }
    #userNameInput {
      width: 60%;
      padding: 6px 8px;
      font-size: 0.9rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-right: 8px;
    }
    #saveUserNameBtn {
      padding: 7px 12px;
      font-size: 0.85rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #2c7be5;
      color: white;
    }
    #currentUserLabel {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #555;
      white-space: pre-line;
    }
    .checkpoint {
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 12px;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .cp-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 1rem;
    }
    .cp-distance {
      font-size: 0.85rem;
      margin-bottom: 6px;
      color: #555;
      white-space: pre-line;
    }
    .cp-status {
      font-size: 0.85rem;
      margin-top: 4px;
      color: #333;
      white-space: pre-line;
    }
    .cp-btn {
      padding: 8px 14px;
      font-size: 0.9rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #2c7be5;
      color: white;
    }
    .cp-btn:disabled {
      background: #bbb;
      opacity: 0.7;
      cursor: not-allowed;
    }
    #globalStatus {
      margin-top: 16px;
      font-size: 0.86rem;
      color: #333;
      white-space: pre-line;
    }
    #log {
      margin-top: 16px;
      font-size: 0.8rem;
      color: #444;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>야모이자 야외방탈출 체크인 시스템</h1>
  <div id="meta"></div>

  <div id="userSection">
    <div>입장 후, <b>참가자 이름 또는 팀명</b>을 입력해 주세요.</div>
    <div style="margin-top:6px;">
      <input
        id="userNameInput"
        type="text"
        placeholder="예) 1조 홍길동, 레드팀, 김대리"
      />
      <button id="saveUserNameBtn">이름 등록</button>
    </div>
    <div id="currentUserLabel">현재 등록된 이름: 없음</div>
  </div>

  <p id="info">
    GPS를 활용해 체크포인트 근처에 도착하면<br />
    각 구역의 ‘여기서 체크인하기’ 버튼이 활성화됩니다.
  </p>

  <h2>체크포인트</h2>
  <div id="checkpointsContainer"></div>

  <div id="globalStatus"></div>

  <h2>체크인 로그 (이 기기에서만 보이는 임시 기록)</h2>
  <div id="log">아직 체크인 기록이 없습니다.</div>

  <script>
    const infoEl = document.getElementById('info');
    const metaEl = document.getElementById('meta');
    const cpContainer = document.getElementById('checkpointsContainer');
    const globalStatusEl = document.getElementById('globalStatus');
    const logEl = document.getElementById('log');

    const userNameInput = document.getElementById('userNameInput');
    const saveUserNameBtn = document.getElementById('saveUserNameBtn');
    const currentUserLabel = document.getElementById('currentUserLabel');

    const STORAGE_KEY = 'yamoiza_gps_checkins';

    // 1. URL 파라미터로 행사/팀 정보 받기 (화면에는 숨김, 내부용)
    const params = new URLSearchParams(window.location.search);
    const eventId = params.get('eventId') || '행사 미지정';
    const teamId  = params.get('teamId')  || '팀 미지정';

    metaEl.textContent = `eventId=${eventId}, teamId=${teamId}`;
    metaEl.style.display = 'none';

    let userName = '';

    saveUserNameBtn.addEventListener('click', () => {
      const value = userNameInput.value.trim();
      if (!value) {
        alert('이름 또는 팀명을 입력해 주세요.');
        return;
      }
      userName = value;
      currentUserLabel.textContent = `현재 등록된 이름: ${userName}`;
      appendLog(`※ 참여자 이름 등록: ${userName}`);
    });

    // 2. 체크포인트 정의 (원하는 만큼 추가 가능)
    const checkpoints = [
      {
        id: 1,
        name: "평창동 가나아트센터",
        lat: 37.6122099878,
        lon: 126.9751811398,
        radiusM: 50,
        checked: false
      },
      {
        id: 2,
        name: "홍제역 (지하철 3호선)",
        lat: 37.5887974,
        lon: 126.94411,
        radiusM: 50,
        checked: false
      }
    ];

    const cpDom = {};
    let currentPos = null;

    // 3. 체크포인트 카드 생성
    checkpoints.forEach(cp => {
      const wrapper = document.createElement('div');
      wrapper.className = 'checkpoint';
      wrapper.id = `cp-${cp.id}`;

      const title = document.createElement('div');
      title.className = 'cp-title';
      title.textContent = cp.name;

      const distance = document.createElement('div');
      distance.className = 'cp-distance';
      distance.id = `cp-distance-${cp.id}`;
      distance.textContent = '현재 거리 계산 중...';

      const btn = document.createElement('button');
      btn.className = 'cp-btn';
      btn.id = `cp-btn-${cp.id}`;
      btn.textContent = '여기서 체크인하기';
      btn.disabled = true;

      const status = document.createElement('div');
      status.className = 'cp-status';
      status.id = `cp-status-${cp.id}`;
      status.textContent = '아직 체크인되지 않았습니다.';

      wrapper.appendChild(title);
      wrapper.appendChild(distance);
      wrapper.appendChild(btn);
      wrapper.appendChild(status);
      cpContainer.appendChild(wrapper);

      cpDom[cp.id] = { distanceEl: distance, btnEl: btn, statusEl: status };

      btn.addEventListener('click', () => handleCheckin(cp.id));
    });

    // 4. 거리 계산 (Haversine)
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // 5. 체크인 버튼 클릭 시
    function handleCheckin(cpId) {
      if (!currentPos) {
        appendLog('⚠ 아직 현재 위치를 가져오지 못했습니다. 잠시 후 다시 시도해 주세요.');
        return;
      }

      const cp = checkpoints.find(c => c.id === cpId);
      if (!cp) return;

      const { btnEl, statusEl } = cpDom[cp.id];

      const dist = getDistance(
        currentPos.latitude,
        currentPos.longitude,
        cp.lat,
        cp.lon
      );

      if (dist <= cp.radiusM) {
        cp.checked = true;
        btnEl.disabled = true;

        const now = new Date();
        const timeStr = now.toLocaleString('ko-KR');
        const displayName = userName || teamId || '이름/팀 미등록';

        const msg =
          `✅ 체크인 완료!\n` +
          `· 장소: ${cp.name}\n` +
          `· 거리: ${dist.toFixed(1)} m (기준: ${cp.radiusM} m 이내)\n` +
          `· 시간: ${timeStr}\n` +
          `· 참가자: ${displayName}`;

        statusEl.textContent = msg;

        appendLog(
          `✔ [${timeStr}]\n` +
          `행사: ${eventId}\n` +
          `참가자: ${displayName}\n` +
          `장소: ${cp.name}\n` +
          `거리: ${dist.toFixed(1)} m`
        );

        updateGlobalStatus();
      } else {
        statusEl.textContent =
          `❌ 반경 밖이라 체크인 불가.\n` +
          `현재 거리: ${dist.toFixed(1)} m / 기준: ${cp.radiusM} m`;
      }
    }

    // 6. 전체 요약 상태
    function updateGlobalStatus() {
      const total = checkpoints.length;
      const done = checkpoints.filter(c => c.checked).length;

      globalStatusEl.textContent =
        `총 체크포인트: ${total}개\n` +
        `완료한 체크인: ${done}개`;
    }

    // 7. 로그 출력 + localStorage 저장
    function appendLog(text) {
      // 화면 표시
      if (logEl.textContent.trim() === '아직 체크인 기록이 없습니다.') {
        logEl.textContent = '';
      }
      const logLine = text;
      logEl.textContent = logLine + '\n\n' + logEl.textContent;
      console.log('[CHECKIN_LOG]', logLine);

      // localStorage 저장 (관리자 페이지용)
      const now = new Date();
      const isoTime = now.toISOString();
      const record = {
        time: isoTime,
        eventId,
        teamId,
        userName: userName || teamId || '이름/팀 미등록',
        rawText: logLine
      };

      const existing = localStorage.getItem(STORAGE_KEY);
      let arr = [];
      if (existing) {
        try {
          arr = JSON.parse(existing);
          if (!Array.isArray(arr)) arr = [];
        } catch (e) {
          arr = [];
        }
      }
      arr.push(record);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    updateGlobalStatus();

    // 8. GPS 위치 추적 시작
    if (!navigator.geolocation) {
      infoEl.textContent =
        '이 브라우저는 GPS(위치 정보)를 지원하지 않습니다.\n' +
        '다른 브라우저(크롬 등)로 다시 시도해 주세요.';
    } else {
      infoEl.textContent =
        'GPS로 현재 위치를 확인하고 있습니다.\n' +
        '체크포인트 근처에 도착하면 버튼이 활성화됩니다.';

      navigator.geolocation.watchPosition(
        (pos) => {
          currentPos = {
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude
          };

          // 안내 텍스트 (좌표는 사용자에게 직접 노출 X)
          infoEl.textContent =
            'GPS로 현재 위치를 확인 중입니다.\n' +
            '근처 체크포인트로 이동해 주세요.';

          checkpoints.forEach(cp => {
            const d = getDistance(
              currentPos.latitude,
              currentPos.longitude,
              cp.lat,
              cp.lon
            );
            const dTxt = d.toFixed(1);
            const { distanceEl, btnEl } = cpDom[cp.id];

            distanceEl.textContent =
              `현재 거리: ${dTxt} m\n` +
              `(체크인 기준: ${cp.radiusM} m 이내)`;

            if (!cp.checked && d <= cp.radiusM) {
              btnEl.disabled = false;
            } else if (!cp.checked) {
              btnEl.disabled = true;
            }
          });

          updateGlobalStatus();
        },
        (err) => {
          infoEl.textContent =
            'GPS 오류가 발생했습니다.\n' +
            '· 위치 권한 허용 여부를 확인해 주세요.\n' +
            '· 실내/지하에서는 인식이 어려울 수 있습니다.\n' +
            `오류 메시지: ${err.message}`;
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000
        }
      );
    }
  </script>
</body>
</html>
